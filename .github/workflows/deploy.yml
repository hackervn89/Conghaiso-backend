name: Deploy Backend to Server

on:
  # KÃ­ch hoáº¡t khi cÃ³ code Ä‘Æ°á»£c Ä‘áº©y lÃªn nhÃ¡nh main
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸš€ Báº¯t Ä‘áº§u triá»ƒn khai Backend..."
            cd /home/hoangvietadmin/conghaiso/Conghaiso-backend
            
            echo "ğŸ”„ KÃ©o code má»›i nháº¥t tá»« nhÃ¡nh main..."
            git fetch --all
            git reset --hard origin/main

            echo "ğŸ“¦ CÃ i Ä‘áº·t cÃ¡c thÆ° viá»‡n cáº§n thiáº¿t..."
            npm install --production

            echo "ğŸ”„ Khá»Ÿi Ä‘á»™ng láº¡i á»©ng dá»¥ng backend vá»›i PM2..."
            # [FIX] Sá»­ dá»¥ng file ecosystem Ä‘á»ƒ Ä‘áº£m báº£o biáº¿n mÃ´i trÆ°á»ng Ä‘Æ°á»£c Ã¡p dá»¥ng Ä‘Ãºng
            # 'reload' sáº½ cáº­p nháº­t á»©ng dá»¥ng mÃ  khÃ´ng cÃ³ thá»i gian cháº¿t (zero-downtime)
            pm2 reload ecosystem.config.js --env production
            
            echo "âœ… Triá»ƒn khai Backend thÃ nh cÃ´ng!"